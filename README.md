# Микросервисное приложение для аренды автомобилей
## Логика работы событий
1. Клиент отправляет ID автомобиля в booking-service для создания бронирования.
2. booking-service делает запрос в car-service, чтобы проверить доступность автомобиля.
3. Если автомобиль доступен, создаётся бронирование со статусом PENDING.
4. Отправляется Kafka-событие о бронировании в car-service.
5. car-service повторно проверяет доступность автомобиля и, если всё в порядке, переводит его в статус BOOKED.
6. В booking-service приходит Kafka-событие от car-service с флагом success.
7. Если success == true, бронирование переходит в статус RESERVED; если success == false, бронирование переходит в статус CANCELLED.
8. После успешного резервирования отправляется событие в payment-service.
9. В payment-service создаётся платёж со статусом NEW.
10. Ответом от payment-service в booking-service приходит payment_id, который прикрепляется к бронированию.
11. Клиент оплачивает платёж, и через Kafka бронирование получает статус PAID.
12. После завершения аренды (возможна только если аренда оплачена) бронирование получает статус COMPLETED, а автомобиль в AVAILABLE.

Каждую минуту выполняется проверка всех неоплаченных бронирований:
- Если с момента создания прошло более 15 минут, происходит отмена бронирования, отмена платежа и статус автомобиля меняется на AVAILABLE

## User-service
Отвечает за регистрацию, авторизацию пользователей и генерацию рефреш-токенов.
Реализована аутентификация по JWT.
Используются роли ROLE_USER и ROLE_ADMIN.

## Api-gateway
Единая точка входа в приложение.
Реализует маршрутизацию запросов ко всем микросервисам, проксирует заголовки, проверяет авторизацию.

## Car-service
CRUD-сервис для машин и моделей машин, статусная система (AVAILABLE, BOOKED, UNDER_REPAIR).
Фильтрация по статусу, реакция на события бронирования (Kafka).

## Booking-service
Обрабатывает бронирования.
Поддерживает создание, завершение, отмену брони при отсутствии оплаты в течение 15 минут.
Сохраняет историю изменения статусов в booking-history.
Проверка наличия и доступности машины через запрос в car-service через CarClient с помощью RestTemplate.
Отправка событий через кафку в car-service, payment-service.

## Payment-service
Хранение и управление платежами.
Поддержка статусов: NEW, PAID, CANCELLED.
Валидация оплаты, отправка событий Kafka.
Пагинация, фильтрация по статусу, защита прав доступа.

## Notification-service
Обрабатывает Kafka-события и отправляет уведомления на почту пользователя, а также push-уведомления через веб-сокеты.
Можно запустить файлик websocket.html для проверки пушей вебсокетов.
Почта, с которой отправляются уведомления, указана в application.yaml

# Инструкция для установки
1) Для поднятия кафки и zookeeper: docker-compose up -d 
2) БД установлено локально через postgresql
3) Запустить каждый сервис

# Источники:
- Аутентификация, генерация токенов: https://www.bezkoder.com/spring-boot-jwt-authentication/
- Api-gateway: https://spring.io/guides/gs/gateway
- Kafka: https://habr.com/ru/companies/slurm/articles/772818/
